<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ParaBank – Assisted Start</title>

<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 40px; background:#fff; }

  .card { max-width: 560px; padding: 26px; border: 1px solid #ddd; border-radius: 14px; }
  h1 { font-size: 18px; margin: 0 0 10px; }
  p { margin: 0 0 14px; color: #333; line-height: 1.4; }
  .btn { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #111; cursor: pointer; font-size: 14px; background: #fff; }
  .btn + .btn { margin-top: 10px; }
  .helper { margin-top: 10px; font-size: 12px; color: #666; }
  .badge { display:inline-block; font-size:12px; padding:2px 8px; border:1px solid #ddd; border-radius:999px; margin-left:8px; color:#444; }

  /* overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.45);
    display: none;
    z-index: 999999;
  }

  .spotlight {
    position: absolute;
    border: 3px solid #3b82f6;
    border-radius: 10px;
    box-shadow: 0 0 0 9999px rgba(0,0,0,.45);
    pointer-events: none;
  }

  .coach {
    position: absolute;
    width: min(420px, calc(100vw - 24px));
    background: #fff;
    border-radius: 14px;
    border: 1px solid #ddd;
    padding: 14px;
    box-shadow: 0 12px 40px rgba(0,0,0,.25);
  }
  .coach h2 { margin: 0 0 8px; font-size: 15px; }
  .coach p { margin: 0 0 12px; font-size: 13px; color: #333; }
  .coach .row { display: flex; gap: 10px; justify-content: flex-end; }
  .coach button { padding: 10px 12px; border-radius: 10px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; font-size: 13px; }
  .coach .ghost { background:#fff; color:#111; border:1px solid #bbb; }
  .tiny { font-size: 12px; color:#666; margin-top: 8px; }
</style>
</head>

<body>
  <div class="card">
    <h1>ParaBank Assisted Signup <span class="badge">in-session start</span></h1>
    <p>Choose how you want to begin:</p>

    <button class="btn" id="btnSignup">Start signup</button>
    <button class="btn" id="btnShare">Continue with screen share</button>

    <div class="helper">We’ll guide you in 2 quick clicks.</div>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="spotlight" id="spotlight"></div>
    <div class="coach" id="coach">
      <h2 id="coachTitle">Step 1 of 2</h2>
      <p id="coachText">Click the <b>+</b> button to open the New tab panel.</p>
      <div class="row">
        <button class="ghost" id="btnExit" type="button">Exit</button>
        <button id="btnNext" type="button">Next</button>
      </div>
      <div class="tiny" id="coachTip">Tip: Keep this open while you click.</div>
    </div>
  </div>

<script>
  const PARABANK_REGISTER_URL = "https://parabank.parasoft.com/parabank/register.htm";

  // Persistence keys
  const K_ACTIVE = "wfGuideActive";   // "1" if user started the guide
  const K_STEP   = "wfGuideStep";     // "1" or "2"

  const overlay = document.getElementById("overlay");
  const spotlight = document.getElementById("spotlight");
  const coach = document.getElementById("coach");
  const coachTitle = document.getElementById("coachTitle");
  const coachText = document.getElementById("coachText");
  const coachTip = document.getElementById("coachTip");
  const btnNext = document.getElementById("btnNext");
  const btnExit = document.getElementById("btnExit");

  let step = 0;
  let pollTimer = null;

  // ---- DOM finders (reactive, no coords) ----
  function findPlus() {
    return document.querySelector(".session-icon-button.tab-new");
  }

  function findShareVisible() {
    const el = document.querySelector('[aria-label="Share screen"]');
    if (!el) return null;
    const r = el.getBoundingClientRect();
    if (r.width === 0 || r.height === 0) return null;
    return el;
  }

  // ---- Overlay positioning that survives transformed ancestors ----
  // Key trick: translate element rect into overlay’s coordinate space.
  function highlight(el, padding = 10) {
    const r = el.getBoundingClientRect();
    const base = overlay.getBoundingClientRect(); // if overlay is inside a transformed container, base won't be (0,0)

    const left = (r.left - base.left) - padding;
    const top  = (r.top  - base.top)  - padding;

    spotlight.style.left = Math.max(8, left) + "px";
    spotlight.style.top  = Math.max(8, top) + "px";
    spotlight.style.width  = Math.max(20, r.width + padding * 2) + "px";
    spotlight.style.height = Math.max(20, r.height + padding * 2) + "px";
  }

  function placeCoachNear(el) {
    const r = el.getBoundingClientRect();
    const base = overlay.getBoundingClientRect();

    // Place coach below the target, clamped into viewport of overlay container
    const desiredLeft = (r.left - base.left);
    const desiredTop  = (r.bottom - base.top) + 12;

    const maxLeft = overlay.clientWidth - 440;
    const maxTop  = overlay.clientHeight - 170;

    coach.style.left = Math.min(maxLeft, Math.max(12, desiredLeft)) + "px";
    coach.style.top  = Math.min(maxTop,  Math.max(12, desiredTop)) + "px";
  }

  function showOverlay() {
    overlay.style.display = "block";
    overlay.setAttribute("aria-hidden", "false");
  }

  function hideOverlay() {
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden", "true");
  }

  function stopPolling() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
  }

  function startPolling(fn) {
    stopPolling();
    pollTimer = setInterval(fn, 200);
  }

  // ---- Steps ----
  function renderStep1() {
    step = 1;
    sessionStorage.setItem(K_STEP, "1");

    coachTitle.textContent = "Step 1 of 2";
    coachText.innerHTML = 'Click the <b>+</b> button to open the New tab panel.';
    coachTip.textContent = "Tip: Keep this open while you click.";
    btnNext.textContent = "Next";

    showOverlay();

    startPolling(() => {
      const plus = findPlus();
      if (plus) {
        highlight(plus, 12);
        placeCoachNear(plus);
      }
    });
  }

  function renderStep2() {
    step = 2;
    sessionStorage.setItem(K_STEP, "2");

    coachTitle.textContent = "Step 2 of 2";
    coachText.innerHTML = 'In the New tab panel, click <b>Share screen</b> next to the URL field.';
    coachTip.textContent = "If you don’t see it yet, click + first.";
    btnNext.textContent = "Done";

    showOverlay();

    startPolling(() => {
      const share = findShareVisible();
      if (share) {
        highlight(share, 14);
        placeCoachNear(share);
      } else {
        // If share isn't visible yet, keep nudging toward +
        const plus = findPlus();
        if (plus) {
          highlight(plus, 12);
          placeCoachNear(plus);
        }
      }
    });
  }

  function endGuide() {
    stopPolling();
    step = 0;
    sessionStorage.removeItem(K_ACTIVE);
    sessionStorage.removeItem(K_STEP);
    hideOverlay();
    spotlight.style.width = "0";
    spotlight.style.height = "0";
  }

  // ---- Button wiring ----
  document.getElementById("btnSignup").addEventListener("click", () => {
    window.location.assign(PARABANK_REGISTER_URL);
  });

  document.getElementById("btnShare").addEventListener("click", () => {
    // Only persist if user explicitly starts it
    sessionStorage.setItem(K_ACTIVE, "1");
    renderStep1();
  });

  btnExit.addEventListener("click", endGuide);

  btnNext.addEventListener("click", () => {
    if (step === 1) renderStep2();
    else endGuide();
  });

  // ---- Persistence across tabs ----
  // Only resume if user explicitly started the guide in THIS browser session.
  (function maybeResume() {
    const active = sessionStorage.getItem(K_ACTIVE);
    const savedStep = sessionStorage.getItem(K_STEP);

    if (active !== "1") return; // prevents auto-start on fresh sessions
    if (savedStep === "1") renderStep1();
    if (savedStep === "2") renderStep2();
  })();

  // Keep aligned on resize
  window.addEventListener("resize", () => {
    if (overlay.style.display === "block") {
      if (step === 1) renderStep1();
      if (step === 2) renderStep2();
    }
  });
</script>
</body>
</html>
